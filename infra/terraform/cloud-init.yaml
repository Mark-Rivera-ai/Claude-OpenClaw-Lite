#cloud-config

package_update: true
package_upgrade: true

packages:
  - docker.io
  - docker-compose
  - fail2ban
  - ufw
  - unattended-upgrades
  - nginx
  - certbot
  - python3-certbot-nginx
  - git

write_files:
  - path: /etc/fail2ban/jail.local
    content: |
      [DEFAULT]
      bantime = 3600
      findtime = 600
      maxretry = 5
      [sshd]
      enabled = true
      port = 22
      maxretry = 3
      bantime = 86400

  - path: /etc/nginx/conf.d/rate-limit.conf
    content: |
      limit_req_zone $$binary_remote_addr zone=api:10m rate=10r/s;

  - path: /etc/nginx/sites-available/openclaw
    content: |
      server {
          listen 80;
          server_name _;
          location / {
              limit_req zone=api burst=20 nodelay;
              proxy_pass http://127.0.0.1:8080;
              proxy_http_version 1.1;
              proxy_set_header Host $$host;
              proxy_set_header X-Real-IP $$remote_addr;
              proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $$scheme;
              proxy_read_timeout 300;
          }
          add_header X-Frame-Options "SAMEORIGIN" always;
          add_header X-Content-Type-Options "nosniff" always;
      }

  - path: /opt/openclaw/.env
    content: |
      OPENAI_API_KEY=${openai_api_key}
      ANTHROPIC_API_KEY=${anthropic_api_key}
      MONTHLY_BUDGET_USD=${monthly_budget_usd}
      COMPLEXITY_THRESHOLD=${complexity_threshold}

runcmd:
  - systemctl enable docker && systemctl start docker
  - usermod -aG docker ubuntu
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 22/tcp
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw --force enable
  - systemctl enable fail2ban && systemctl start fail2ban
  - rm -f /etc/nginx/sites-enabled/default
  - ln -sf /etc/nginx/sites-available/openclaw /etc/nginx/sites-enabled/
  - nginx -t && systemctl reload nginx
  - git clone https://github.com/Mark-Rivera-ai/Claude-OpenClaw-Lite.git /opt/openclaw/repo
  - cp -r /opt/openclaw/repo/app /opt/openclaw/app
  - cp /opt/openclaw/repo/docker-compose.yml /opt/openclaw/
  - cd /opt/openclaw && docker-compose up -d --build
  - |
    if [ -n "${domain_name}" ] && [ -n "${admin_email}" ]; then
      certbot --nginx -d ${domain_name} --non-interactive --agree-tos -m ${admin_email}
    fi

final_message: "OpenClaw Lite ready!"
